variables:
  # Commit of ghc/ci-images repository from which to pull Docker images
  DOCKER_REV: 3f731f5d37a156e7ebe10cd32656946083baaf4a

  GHC_VERSION: 8.10.1
  CABAL_INSTALL_VERSION: 3.2.0.0

.build:
  script:
    - cabal update
    - cabal v2-install cabal-install --installdir=$(pwd)/out --install-method=copy --overwrite-policy=always
  artifacts:
    expire_in: 2 week
    paths:
      - out

build-aarch64-linux-deb9:
  extends: .build
  tags:
    - aarch64-linux
  image: "registry.gitlab.haskell.org/ghc/ci-images/aarch64-linux-deb9:$DOCKER_REV"

build-armv7-linux-deb9:
  extends: .build
  tags:
    - armv7-linux
  image: "registry.gitlab.haskell.org/ghc/ci-images/armv7-linux-deb9:$DOCKER_REV"

build-x86_64-linux:
  extends: .build
  tags:
    - x86_64-linux
  image: "registry.gitlab.haskell.org/ghc/ci-images/x86_64-linux-deb9:$DOCKER_REV"

build-x86_64-freebsd:
  extends: .build
  before_script:
    # We don't have sudo access in GitLab CI, so we can't just dump binaries in
    # the usual PATH locations.
    - toolchain="$(pwd)/toolchain/"
    - mkdir -p "$toolchain/bin/"
    - export PATH="$toolchain/bin:$PATH"

    # Install cabal from hasufell's binaries. See https://github.com/haskell/cabal/issues/6616#issuecomment-616336384.
    - curl -o cabal.tar.xz 'https://hasufell.de/d/d3e215db133e4fcaa61e/files/?p=/cabal-install-$CABAL_INSTALL_VERSION-x86_64-portbld-freebsd.tar.xz&dl=1'
    - tar --directory "$toolchain/bin/" -xf cabal.tar.xz cabal
    - chmod +x "$toolchain/bin/cabal"
  tags:
    - x86_64-freebsd
  image: "registry.gitlab.haskell.org/ghc/ci-images/x86_64-freebsd:$DOCKER_REV"

build-x86_64-linux-alpine:
  extends: .build
  tags:
    - x86_64-linux
  image: "registry.gitlab.haskell.org/ghc/ci-images/x86_64-linux-alpine:$DOCKER_REV"

build-x86_64-darwin:
  extends: .build
  before_script:
    # We don't have sudo access in GitLab CI, so we can't just dump binaries in
    # the usual PATH locations.
    - toolchain="$(pwd)/toolchain/"
    - mkdir -p "$toolchain/bin/"
    - export PATH="$toolchain/bin:$PATH"

    # Install cabal
    - curl -o cabal.tar.xz https://downloads.haskell.org/~cabal/cabal-install-$CABAL_INSTALL_VERSION/cabal-install-$CABAL_INSTALL_VERSION-x86_64-apple-darwin17.7.0.tar.xz
    - tar --directory "$toolchain/bin/" -xf cabal.tar.xz cabal
    - chmod +x "$toolchain/bin/cabal"

    # Install ghc
    - curl -sSfL -o ghc.tar.xz "https://downloads.haskell.org/~ghc/$GHC_VERSION/ghc-$GHC_VERSION-x86_64-apple-darwin.tar.xz"
    - tar -xf ghc.tar.xz
    - pushd "ghc-${GHC_VERSION}"; ./configure --prefix="$toolchain"; make install; popd
  tags:
    - x86_64-darwin
